<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hedged Composition Calculator — Base Dipinjam (DexScreener)</title>
<style>
  :root{--bg:#0b0f13;--card:#141a21;--text:#e8eef6;--muted:#9db0c2;--accent:#4fd1c5;--bad:#ff7878;--good:#8be28b}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;background:var(--bg);color:var(--text)}
  header{padding:18px 20px;text-align:center;border-bottom:1px solid #1e2630;background:linear-gradient(180deg,#0f141a,#0b0f13)}
  main{max-width:980px;margin:22px auto;padding:0 14px 60px}
  h1{margin:0;font-size:20px}
  h2{font-size:15px;margin:0 0 10px;color:var(--muted);font-weight:700}
  .card{background:var(--card);border:1px solid #1f2933;border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
  input, select{width:100%;padding:11px;border-radius:10px;background:#0d1217;border:1px solid #243140;color:var(--text);font-size:14px}
  input:focus, select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(79,209,197,.12)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{cursor:pointer;background:var(--accent);color:#052b27;border:0;border-radius:10px;padding:10px 14px;font-weight:700}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0f171f;border:1px solid #223041;color:var(--muted);font-size:12px}
  .kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:8px}
  .kpi .item{background:#0f141a;border:1px solid #1f2a35;border-radius:12px;padding:14px}
  .kpi .label{font-size:12px;color:var(--muted)}
  .kpi .value{font-size:22px;margin-top:6px}
  .ok{color:var(--good)} .warn{color:var(--bad)}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  th,td{padding:12px 14px;text-align:left}
  th{color:var(--muted);font-weight:600}
  tr.cardrow{background:#0f141a;border:1px solid #1f2a35}
  tr.cardrow td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tr.cardrow td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .small{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header>
  <h1>Hedged Composition Calculator</h1>
  <div class="small">Masukkan URL DexScreener pair atau pilih dari preset. Hitung posisi hedged kamu untuk pair apa saja (USDC/BTC, ETH/BTC, dll) dengan utang di base atau quote token.</div>
</header>

<main>
  <div class="card">
    <h2>1) Pair & Harga</h2>
    <div class="grid">
      <div>
        <label>Pick pair (preset DexScreener)</label>
        <select id="pairPreset">
          <option value="">— pilih pair preset —</option>
          <!-- options akan diisi otomatis (RECALL/USDC, CARV/USDC, dll) -->
        </select>
      </div>
      <div style="grid-column:span 2">
        <label>DexScreener Pair URL (bisa tempel manual)</label>
        <input id="pairUrl" placeholder="https://dexscreener.com/base/<pairAddress>" />
      </div>
      <div>
        <label>Refresh interval (detik)</label>
        <input id="intervalSec" value="15" />
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="refresh">Refresh harga</button>
      <span class="pill" id="status">Idle</span>
    </div>
  </div>

  <div class="card">
    <h2>2) Modal & Kewajiban</h2>
    <div class="grid">
      <div>
        <label>Modal awal kamu</label>
        <select id="initialCapitalType" style="margin-bottom:6px">
          <option value="base">Base token</option>
          <option value="quote">Quote token</option>
        </select>
        <input id="initialCapital" value="0" placeholder="Jumlah modal awal" />
      </div>
      <div>
        <label>Token yang kamu utang (wajib dikembalikan)</label>
        <select id="debtType" style="margin-bottom:6px">
          <option value="base">Base token</option>
          <option value="quote">Quote token</option>
        </select>
        <input id="debtAmount" value="0" placeholder="Jumlah utang" />
      </div>
    </div>
    <div class="small">Contoh: Pair ETH/BTC, utang 0.5 ETH → pilih "Base token" & isi 0.5. Atau utang 10,000 USDC di pair USDC/BTC → pilih "Quote token" & isi 10000.</div>
  </div>

  <div class="card">
    <h2>3) Posisi Sekarang</h2>
    <div class="grid">
      <div>
        <label>Base token yang kamu pegang sekarang</label>
        <input id="baseNow" value="0" placeholder="Jumlah base token" />
      </div>
      <div>
        <label>Quote token yang kamu pegang sekarang</label>
        <input id="quoteNow" value="0" placeholder="Jumlah quote token" />
      </div>
      <div>
        <label>Biaya swap % (opsional, mis. 0.3)</label>
        <input id="feePct" value="0" placeholder="0.3" />
      </div>
    </div>
  </div>

  <div class="card">
    <h2>4) Ringkasan</h2>
    <div class="kpi">
      <div class="item"><div class="label">Pair</div><div class="value" id="kpiPair">–</div></div>
      <div class="item"><div class="label">Harga Base (USD)</div><div class="value" id="kpiBaseUsd">$ –</div></div>
      <div class="item"><div class="label">Harga Quote (USD)</div><div class="value" id="kpiQuoteUsd">$ –</div></div>
      <div class="item"><div class="label">Short/Surplus token utang</div><div class="value" id="kpiBaseGap">–</div></div>
      <div class="item"><div class="label">Quote dibutuhkan/tersisa utk lunasi</div><div class="value" id="kpiQuoteNeedLeft">–</div></div>
      <div class="item"><div class="label">Net Quote jika ditutup</div><div class="value" id="kpiNetQuote">–</div></div>
      <div class="item"><div class="label">PnL vs modal awal</div><div class="value" id="kpiPnl">–</div></div>
    </div>
  </div>

  <div class="card">
    <h2>5) Rincian Rugi/Laba</h2>
    <table>
      <thead>
        <tr><th>Item</th><th>Qty</th><th>USD</th><th>Keterangan</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</main>

<script>
const $ = (id)=>document.getElementById(id);
function parseFlex(v){ v=String(v??'').trim().replace(/\s/g,'').replace(',', '.'); if(!v) return NaN; const n=Number(v); return isFinite(n)?n:NaN; }
function fmt(n,d=6){ if(!isFinite(n)) return '–'; return Number(n).toLocaleString(undefined,{maximumFractionDigits:d}); }
function setStatus(s){ $('status').textContent=s; }

// ====== PRESET PAIRS (URLs dari kamu) ======
const PRESET_URLS = [
  'https://dexscreener.com/base/0x5e3791f68ebceac82788f3becab154c15141a2f4', // RECALL/USDC (akan diberi nama otomatis)
  'https://dexscreener.com/base/0xff862675c47b6a2c9072dcbe2f37a78a445c4f37', // CARV/USDC
  'https://dexscreener.com/base/0xe30d5bf485f7476ac15884a28ffb3c9cea635dcb', // (auto-name)
  'https://dexscreener.com/base/0x7af45dfaf2fdea139b2295f37ffea2e16e6fd8ba', // (auto-name)
];

// build preset dropdown labels by fetching pair symbols
async function buildPresetOptions(){
  const sel = $('pairPreset');
  // clear except first
  sel.length = 1;
  for(const url of PRESET_URLS){
    try{
      const u = new URL(url);
      const [chain, pair] = u.pathname.split('/').filter(Boolean);
      const r = await fetch(`https://api.dexscreener.com/latest/dex/pairs/${chain}/${pair}`, {cache:'no-store'});
      const j = await r.json();
      const base = (j?.pair?.baseToken?.symbol || 'BASE').toUpperCase();
      const quote= (j?.pair?.quoteToken?.symbol || 'QUOTE').toUpperCase();
      const opt = document.createElement('option');
      opt.value = url;
      opt.textContent = `${base}/${quote}`;
      sel.appendChild(opt);
    }catch(e){
      const opt = document.createElement('option');
      opt.value = url;
      opt.textContent = `Pair (load fail) • ${url.slice(-8)}`;
      sel.appendChild(opt);
    }
  }
}

// when user picks preset, copy to input and refresh
$('pairPreset').addEventListener('change', ()=>{
  const v = $('pairPreset').value;
  if(v){
    $('pairUrl').value = v;
    refreshNow();
  }
});

async function fetchEthUsd(){
  try{
    const r=await fetch('https://api.binance.com/api/v3/ticker/price?symbol=ETHUSDT',{cache:'no-store'});
    const j=await r.json(); const px=Number(j.price); return isFinite(px)?px:NaN;
  }catch{ return NaN }
}
async function fetchPair(){
  const url=$('pairUrl').value.trim(); if(!url) throw new Error('Pair URL kosong');
  const u=new URL(url); const [chain,pair]=u.pathname.split('/').filter(Boolean);
  const r=await fetch(`https://api.dexscreener.com/latest/dex/pairs/${chain}/${pair}`,{cache:'no-store'});
  return r.json(); // {pair:{priceUsd, baseToken, quoteToken, quotePriceUsd?}}
}

function row(label, qty, usd, note){
  const tr=document.createElement('tr'); tr.className='cardrow';
  tr.innerHTML=`<td>${label}</td><td>${qty}</td><td>${usd}</td><td>${note||''}</td>`;
  return tr;
}

async function refreshNow(){
  try{
    setStatus('Ambil harga…');
    const j = await fetchPair();
    const baseSym  = (j?.pair?.baseToken?.symbol||'BASE').toUpperCase();
    const quoteSym = (j?.pair?.quoteToken?.symbol||'QUOTE').toUpperCase();
    const baseUsd  = Number(j?.pair?.priceUsd);
    if(!isFinite(baseUsd)) throw new Error('Harga base tidak valid');

    let quoteUsd=1;
    if(['USDC','USDT','DAI','USDCE','USDC.E'].includes(quoteSym)){ quoteUsd=1; }
    else if(['WETH','ETH'].includes(quoteSym)){ quoteUsd=await fetchEthUsd(); }
    else { const qp=Number(j?.pair?.quotePriceUsd); if(isFinite(qp)) quoteUsd=qp; }

    const initialCapitalType = $('initialCapitalType').value;
    const initialCapital = parseFlex($('initialCapital').value);
    const debtType = $('debtType').value;
    const debtAmount = parseFlex($('debtAmount').value);
    const baseNow = parseFlex($('baseNow').value);
    const quoteNow = parseFlex($('quoteNow').value);
    const feePct = Math.max(0, parseFlex($('feePct').value)||0)/100;
    
    if(![initialCapital, debtAmount, baseNow, quoteNow].every(isFinite)) { 
      setStatus('Isi semua angka'); 
      return; 
    }

    // Convert initial capital to USD for PnL calculation
    let initialCapitalUsd;
    if(initialCapitalType === 'base') {
      initialCapitalUsd = initialCapital * baseUsd;
    } else {
      initialCapitalUsd = initialCapital * quoteUsd;
    }

    // Calculate debt gap based on debt type
    let debtGap, debtGapAbs, debtTokenSym, debtTokenUsd;
    if(debtType === 'base') {
      debtGap = debtAmount - baseNow;
      debtGapAbs = Math.abs(debtGap);
      debtTokenSym = baseSym;
      debtTokenUsd = baseUsd;
    } else {
      debtGap = debtAmount - quoteNow;
      debtGapAbs = Math.abs(debtGap);
      debtTokenSym = quoteSym;
      debtTokenUsd = quoteUsd;
    }

    // Calculate quote needed/available for debt repayment
    let quoteNeededRaw = 0, quoteNeeded = 0, quoteFromSurplusRaw = 0, quoteFromSurplus = 0;
    if(debtType === 'base') {
      // Need to buy base token with quote
      quoteNeededRaw = (debtGap > 0) ? debtGap * baseUsd / quoteUsd : 0;
      quoteNeeded = (debtGap > 0) ? quoteNeededRaw * (1 + feePct) : 0;
      quoteFromSurplusRaw = (debtGap < 0) ? debtGapAbs * baseUsd / quoteUsd : 0;
      quoteFromSurplus = (debtGap < 0) ? quoteFromSurplusRaw * (1 - feePct) : 0;
    } else {
      // Debt is in quote token
      if(debtGap > 0) {
        // We need more quote. Calculate how much after converting base
        const baseValueInQuote = baseNow * baseUsd / quoteUsd * (1 - feePct);
        const quoteShortfall = debtGap;
        // Additional quote needed after converting base (if any)
        quoteNeededRaw = Math.max(0, quoteShortfall - baseValueInQuote);
        quoteNeeded = quoteNeededRaw; // Already in quote terms, no conversion fee needed
      } else {
        // We have surplus quote
        quoteFromSurplusRaw = debtGapAbs;
        quoteFromSurplus = quoteFromSurplusRaw;
      }
    }

    // Calculate net quote if position closed
    let netQuoteIfClose;
    if(debtType === 'base') {
      // Sell all base, pay debt, keep remaining quote
      // Net quote = quoteNow - quoteNeeded (to buy base) + (baseNow after buying) - debtAmount in base value
      // Simplified: quoteNow + (baseNow - debtAmount) * basePrice/quotePrice - fees
      const baseValueInQuote = (baseNow - debtAmount) * baseUsd / quoteUsd;
      netQuoteIfClose = quoteNow + baseValueInQuote
                       - (debtGap > 0 ? feePct * quoteNeededRaw : 0)
                       - (debtGap < 0 ? feePct * quoteFromSurplusRaw : 0);
    } else {
      // Convert all base to quote, pay debt, keep remaining
      // Net quote = quoteNow + baseNow converted to quote - debtAmount - fees
      const baseValueInQuote = baseNow * baseUsd / quoteUsd * (1 - feePct); // After selling fee
      netQuoteIfClose = quoteNow + baseValueInQuote - debtAmount;
      // If we had a shortfall and needed to add more quote, that's already accounted in the calculation above
    }

    // Calculate PnL in USD
    const netQuoteUsd = netQuoteIfClose * quoteUsd;
    const pnl = netQuoteUsd - initialCapitalUsd;

    // Update KPI displays
    $('kpiPair').textContent = `${baseSym}/${quoteSym}`;
    $('kpiBaseUsd').textContent  = '$ ' + fmt(baseUsd,6);
    $('kpiQuoteUsd').textContent = '$ ' + fmt(quoteUsd,6);
    
    $('kpiBaseGap').textContent = (debtGap > 0 
      ? `Short ${fmt(debtGapAbs)} ${debtTokenSym}` 
      : debtGap < 0 
        ? `Surplus ${fmt(debtGapAbs)} ${debtTokenSym}` 
        : 'Pas (0)');
    
    $('kpiQuoteNeedLeft').textContent = debtGap > 0
      ? (`Butuh ${fmt(quoteNeeded,6)} ${quoteSym}`)
      : debtGap < 0
        ? (`Tersedia ${fmt(quoteFromSurplus,6)} ${quoteSym}`)
        : `0 ${quoteSym}`;
    
    $('kpiNetQuote').textContent = `${fmt(netQuoteIfClose,6)} ${quoteSym}`;
    $('kpiPnl').textContent = (pnl >= 0 ? '+ ' : '- ') + '$ ' + fmt(Math.abs(pnl), 2);
    $('kpiPnl').className = 'value ' + (pnl >= 0 ? 'ok' : 'warn');

    // Update detail table
    const tb = $('tbody'); 
    tb.innerHTML = '';
    
    tb.appendChild(row(`Kekurangan/Surplus ${debtTokenSym}`, 
      debtGap > 0 ? `${fmt(debtGap)} ${debtTokenSym}` : debtGap < 0 ? `${fmt(debtGapAbs)} ${debtTokenSym}` : '0', 
      '$ ' + fmt(debtGapAbs * debtTokenUsd, 2),
      debtGap > 0 ? 'Harus dibeli/ditukar untuk lunas' : 'Surplus jika dilunasi sekarang'
    ));
    
    tb.appendChild(row(`${baseSym} sekarang`, 
      `${fmt(baseNow)} ${baseSym}`, 
      '$ ' + fmt(baseNow * baseUsd, 2), 
      'Milikmu'
    ));
    tb.appendChild(row(`${quoteSym} sekarang`, 
      `${fmt(quoteNow)} ${quoteSym}`, 
      '$ ' + fmt(quoteNow * quoteUsd, 2), 
      'Milikmu'
    ));
    
    if(debtGap > 0){
      if(debtType === 'base') {
        tb.appendChild(row(`${quoteSym} dibutuhkan untuk beli ${debtTokenSym}`, 
          '—', 
          `${fmt(quoteNeeded, 6)} ${quoteSym}`, 
          feePct ? `Termasuk fee ~${(feePct*100).toFixed(2)}%` : ''
        ));
        tb.appendChild(row(`Sisa/kurang ${quoteSym} setelah lunasi`, 
          '—', 
          `${fmt(quoteNow - quoteNeeded, 6)} ${quoteSym}`, 
          (quoteNow >= quoteNeeded ? `✅ Cukup ${quoteSym}` : `❌ ${quoteSym} kurang, perlu tambah`)
        ));
      } else {
        // Debt is quote
        const baseValueInQuote = baseNow * baseUsd / quoteUsd * (1 - feePct);
        if(baseNow > 0) {
          tb.appendChild(row(`${baseSym} yang bisa dikonversi ke ${quoteSym}`, 
            `${fmt(baseNow)} ${baseSym}`, 
            `${fmt(baseValueInQuote, 6)} ${quoteSym}`, 
            feePct ? `Setelah fee ~${(feePct*100).toFixed(2)}%` : ''
          ));
        }
        if(quoteNeeded > 0) {
          tb.appendChild(row(`${quoteSym} tambahan yang dibutuhkan`, 
            '—', 
            `${fmt(quoteNeeded, 6)} ${quoteSym}`, 
            'Setelah konversi base (jika ada)'
          ));
        }
        const totalAvailable = quoteNow + baseValueInQuote;
        tb.appendChild(row(`Total ${quoteSym} tersedia vs utang`, 
          `${fmt(totalAvailable, 6)} vs ${fmt(debtAmount, 6)}`, 
          `${fmt(totalAvailable - debtAmount, 6)} ${quoteSym}`, 
          (totalAvailable >= debtAmount ? `✅ Cukup untuk lunasi` : `❌ Masih kurang`)
        ));
      }
    } else if(debtGap < 0){
      if(debtType === 'base') {
        tb.appendChild(row(`${quoteSym} dari jual surplus ${debtTokenSym}`, 
          '—', 
          `${fmt(quoteFromSurplus, 6)} ${quoteSym}`, 
          feePct ? `Neto sesudah fee` : ''
        ));
        tb.appendChild(row(`${quoteSym} total setelah lunasi`, 
          '—', 
          `${fmt(quoteNow + quoteFromSurplus, 6)} ${quoteSym}`, 
          'Estimasi jika surplus dijual'
        ));
      } else {
        // Debt is quote, we have surplus
        tb.appendChild(row(`Surplus ${quoteSym} setelah lunasi`, 
          `${fmt(debtGapAbs)} ${quoteSym}`, 
          '$ ' + fmt(debtGapAbs * quoteUsd, 2), 
          'Lebih dari yang diutang'
        ));
      }
    }
    
    const netDesc = debtType === 'base' 
      ? 'Quote + (Base-utang)×harga (termasuk fee kira-kira)'
      : 'Quote + Base dikonversi - utang (termasuk fee)';
    tb.appendChild(row(`Net ${quoteSym} jika ditutup sekarang`, 
      '—', 
      `${fmt(netQuoteIfClose, 6)} ${quoteSym}`, 
      netDesc
    ));
    
    tb.appendChild(row('PnL vs modal awal', 
      '—', 
      (pnl >= 0 ? '+ ' : '- ') + '$ ' + fmt(Math.abs(pnl), 2), 
      pnl >= 0 ? 'Profit (USD)' : 'Rugi (USD)'
    ));

    setStatus('Live OK');
  }catch(e){
    console.error(e);
    setStatus('Fetch gagal / input belum lengkap');
  }
}

$('refresh').addEventListener('click', refreshNow);
['pairUrl','initialCapital','debtAmount','baseNow','quoteNow','feePct'].forEach(id=>$(id).addEventListener('input', refreshNow));
['initialCapitalType','debtType'].forEach(id=>$(id).addEventListener('change', refreshNow));

// auto refresh
let timer=null;
function startAuto(){
  if(timer) clearInterval(timer);
  const sec=Math.max(5, parseInt(($('intervalSec').value||'15'),10));
  timer=setInterval(refreshNow,sec*1000);
}
$('intervalSec').addEventListener('input', startAuto);

// init
buildPresetOptions(); // <-- isi dropdown dari 4 URL
refreshNow(); 
startAuto();
</script>
</body>
</html>
